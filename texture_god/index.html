<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
<head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=2">

  <title> TextureGod ，“窥视”显卡内部的贴图和滤镜 </title>

  
  <link rel="stylesheet" href="http://topdevil.com//css/poole.css">
  <link rel="stylesheet" href="http://topdevil.com//css/syntax.css">
  <link rel="stylesheet" href="http://topdevil.com//css/hyde.css">
  <link rel="stylesheet" href="http://fonts.useso.com/css?family=PT+Sans:400,400italic,700|Abril+Fatface">

  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/apple-touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="/favicon.ico">

  
  <link href="" rel="alternate" type="application/rss+xml" title="破耳狼" />
  
  
			<link rel="stylesheet" href="http://topdevil.com//css/prettify.css">
			<script src="http://topdevil.com//css/jquery.js"></script>
			<script src="http://topdevil.com//css/prettify.js"></script>
			<script type="text/javascript">
        function lineDistance( point1, point2 )
        {
          var xs = 0;
          var ys = 0;
         
          xs = point2.x - point1.x;
          xs = xs * xs;
         
          ys = point2.y - point1.y;
          ys = ys * ys;
         
          return Math.sqrt( xs + ys );
        }
				$(function(){
				$("pre").addClass("prettyprint linenums");
					prettyPrint();
          $("pre").on("mousedown",function(e){
              var me = $(this);
              me.data("posx",e.pageX);
              me.data("posy",e.pageY);
          });
          $("pre").on("mouseup",function(e){
              var me = $(this);
              me.data("posx");
              var p1 = {x:me.data("posx"),y:me.data("posy")};
              var p2 = {x:e.pageX,y:e.pageY};
              if(lineDistance(p2,p1)<10){
                var has = me.data("hasclick");
                if(has){
                  me.width(me.width()/3.2);
                  me.data("hasclick",false);
                }else{
                  me.width(me.width()*3.2);
                  me.data("hasclick",true);
                }
              }
          });
				});

			</script>
</head>

<body>

<div class="sidebar">
  <div class="container sidebar-sticky">
    <div class="sidebar-about">
      <h1>破耳狼</h1>
      <p class="lead">
      美术与程序双工<br/>GitHub Url : <a href="http://github.com/moketao">GitHub.com/moketao</a>
      </p>
    </div>

    <ul class="sidebar-nav">
      <li><a href="/">Home</a> </li>
      
    </ul>

    <p>&copy; 2016. All rights reserved. </p>
  </div>
</div>


    <div class="content container">
<div class="post">
  <h1>TextureGod ，“窥视”显卡内部的贴图和滤镜</h1>
  <span class="post-date">2015-04-19</span>
      <p><img src="/img/tg.png" alt="" />
</p>

<p>有段时间，我对于 Adobe scout 非常不满，并且对项目频频闪退，也很恼火。</p>

<p>于是。。。</p>

<p><strong>TextureGod</strong> 诞生了。</p>

<p>用来 “监控” Starling 和 FeathersUI 的贴图，“窥视”显卡内部的贴图、滤镜。</p>

<p>如果想知道某张贴图或者滤镜，是否被多次 new 出来浪费了显存，</p>

<p>只要打开 TextureGod 就能一目了然。</p>

<p>其实用 TextureGod 来取名，确实有点托大，不过，当时没时间多想，急着解决问题。
所以就取了这样一个名字。</p>

<p>说起来原理非常简单：</p>

<p>TextureGod 并不是真的能读取显卡的显存，而是通过socket连接游戏，监控贴图上传显卡和销毁贴图的过程，主要是通过修改 Starling 的 Texture 这个类。</p>

<p>修改的地方如下：</p>

<pre>
starling.textures.Texture
    fromAtfData 方法中的参数 async，声明的类型从Function修改为通配类型
    async:Function -> async:*

Texture
    添加如下三个属性：
        public var name:String;//fix
        public static var hasGodSon:Boolean;//这个值在 TextureGodSon 的构造函数中设置//fix
        public static var TextureGodSonClass:*;//fix
    构造函数里加入：
        if(hasGodSon)name = Math.random()+"";//fix
    
    在 fromBitmapData 函数中加入：
        if(hasGodSon)TextureGodSonClass.add(texture.name,data);//fix
    
    在 fromAtfData 函数中加入：
        if(hasGodSon)TextureGodSonClass.add(concreteTexture.name,data);//fix
    
    在 dispose 函数中加入：
        if(hasGodSon)TextureGodSonClass.remove(name);//子类会通过super.dispose调用到此处//fix
    
ColorMatrixFilter
    构造函数前三行，改为：
        public function ColorMatrixFilter(matrix:Vector.<Number>=null,name:String="")//fix
        {
            super(1,1.0,name);
            if(name==""||name==null) throw new Error("使用滤镜请加名字，便于排查问题");//fix
        
FragmentFilter
    添加两个属性：
            public var name:String;//fix
            public var hasDispose:Boolean;//fix
    构造函数加上：
        public function FragmentFilter(numPasses:int=1, resolution:Number=1.0,name:String="")//fix
        {
            if(Texture.hasGodSon){//fix
                this.name = name+Math.random();//fix
                if(name=="" || name==null) this.name = "filter_"+Math.random();//fix
                Texture.TextureGodSonClass.add(this.name);//fix
            }//fix
    dispose 函数中加入：
            if(Texture.hasGodSon) Texture.TextureGodSonClass.remove(name);//fix
            hasDispose = true;//fix


</pre>

<p>说到底就一句话：</p>

<p>贴图产生的时候，给贴图取个名，然后把bitmap存到字典里。</p>

</div>

  <div class="ds-thread" data-thread-key="/texture_god/" data-title="TextureGod ，“窥视”显卡内部的贴图和滤镜" data-url="http://topdevil.com/texture_god/"></div>


<script type="text/javascript">
var duoshuoQuery = {short_name:"topdevil"};
  (function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0] 
     || document.getElementsByTagName('body')[0]).appendChild(ds);
  })();
  </script>

</div>

  </body>
</html>
